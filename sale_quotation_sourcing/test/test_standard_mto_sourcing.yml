-
  I select for this file a user that is not admin
-
  !context
  uid: 'res_users_fiona'
-
  I create a quotation that is not manually sourced. This is the reference,
  standard case that we will want to compare to the manually sourced case.
-
  !record {model: sale.order, id: so_1}:
    partner_id: base.res_partner_2
    payment_term: account.account_payment_term
    order_line:
      - product_id: product.product_product_7
        product_uom_qty: 8
-
  I confirm the sale order, run the scheduler, check that I have two
  procurements, and the second one is attached to a purchase order.
-
  !python {model: sale.order}: |
    from nose.tools import *

    retval = self.action_button_confirm(cr, uid, ref('so_1'), context=context)
    assert_is(retval, True)
    
    so = model.browse(cr, uid, ref('so_1'))
    assert_not_equal(so.state, u'draft')

    self.pool['procurement.order'].run_scheduler(cr, uid)

    line_procurements = so.order_line[0].procurement_ids
    assert_equal(len(line_procurements), 1)

    proc1 = line_procurements[0]
    assert_equal(proc1.rule_id.action, "move")
    assert_equal(proc1.state, "running")
    assert_false(proc1.purchase_line_id)

    proc2 = proc1.group_id.procurement_ids - proc1
    assert_equal(proc2.rule_id.action, "buy")
    assert_equal(proc2.state, "running")
    assert_true(proc2.purchase_line_id)

    pickings = so.picking_ids

    assert_equal(len(pickings), 1)

    pick1 = pickings[0]
    assert_equal(pick1.picking_type_code, u'outgoing')
